# ???????????????????????????????????????????????????????????????????????????????
# TEMPLATE API - Configuration principale
# Spring Boot 4.0.0 | Java 21 LTS
# ???????????????????????????????????????????????????????????????????????????????

spring:
  application:
    name: template-api

  # ?????????????????????????????????????????????????????????????????????????????
  # BASE DE DONNeES (PostgreSQL)
  # ?????????????????????????????????????????????????????????????????????????????
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://localhost:5432/template_db}
    username: ${DATABASE_USERNAME:postgres}
    password: ${DATABASE_PASSWORD:password}
    driver-class-name: org.postgresql.Driver

    # HikariCP - Pool de connexions optimise
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      idle-timeout: 300000        # 5 minutes
      connection-timeout: 20000   # 20 secondes
      max-lifetime: 1200000       # 20 minutes

  # ?????????????????????????????????????????????????????????????????????????????
  # JPA / HIBERNATE
  # ?????????????????????????????????????????????????????????????????????????????
  jpa:
    hibernate:
      ddl-auto: validate  # ?? JAMAIS 'create' ou 'update' en prod ! Utiliser Liquibase
    show-sql: false
    open-in-view: false   # ?? Desactive pour eviter les lazy loading en dehors des transactions
    properties:
      hibernate:
        format_sql: true
        jdbc:
          time_zone: UTC
        # Protection contre les N+1 queries
        default_batch_fetch_size: 25

  # ?????????????????????????????????????????????????????????????????????????????
  # LIQUIBASE (Migrations de schema)
  # ?????????????????????????????????????????????????????????????????????????????
  liquibase:
    enabled: true
    change-log: classpath:db/changelog/db.changelog-master.yaml
    contexts: dev,test  # ?? Charge les donnees de test en environnement dev/test uniquement

  # ?????????????????????????????????????????????????????????????????????????????
  # OAUTH2 (Google Login)
  # ?????????????????????????????????????????????????????????????????????????????
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID:}
            client-secret: ${GOOGLE_CLIENT_SECRET:}
            scope:
              - email
              - profile
  web:
    error:
      include-message: never
      include-stacktrace: never
      include-binding-errors: never
  profiles:
    active: @spring.profiles.active@

# ???????????????????????????????????????????????????????????????????????????????
# SERVEUR
# ???????????????????????????????????????????????????????????????????????????????
server:
  port: ${PORT:8080}

  # ?? Securite HTTP
  # Compression GZIP
  compression:
    enabled: true
    min-response-size: 1024
    mime-types: application/json,application/xml,text/html,text/plain

  # Tomcat
  tomcat:
    # ?? Protection contre les attaques Slowloris
    connection-timeout: 5000
    max-connections: 200
    accept-count: 100
    threads:
      max: 200
      min-spare: 10

# ???????????????????????????????????????????????????????????????????????????????
# JWT - Configuration securisee
# ???????????????????????????????????????????????????????????????????????????????
jwt:
  # ? Cle secrete (min 256 bits = 32 caracteres pour HS256)
  # En production : utiliser une cle generee aleatoirement et stockee dans un vault
  secret: ${JWT_SECRET:CHANGE_ME_IN_PRODUCTION_USE_AT_LEAST_256_BITS_SECRET_KEY_HERE_MIN_32_CHARS}

  # Durees de vie
  access-token:
    expiration: 5m       # 5 minutes (standard bancaire pour limiter l'impact d'un vol)
  refresh-token:
    expiration: 7d       # 7 jours

  # Metadata
  issuer: ${JWT_ISSUER:template-api}
  audience: ${JWT_AUDIENCE:template-app}

# ???????????????????????????????????????????????????????????????????????????????
# SECURITE APPLICATIVE
# ???????????????????????????????????????????????????????????????????????????????
app:
  security:
    # ? Configuration des cookies d'authentification HTTP-only
    cookie:
      secure: ${COOKIE_SECURE:false}           # true en production (HTTPS)
      domain: ${COOKIE_DOMAIN:}                # Domaine du cookie (vide = domaine courant)
      same-site: ${COOKIE_SAME_SITE:Lax}    # Strict, Lax, ou None

    # CORS
    cors:
      allowed-origins: ${FRONTEND_URL:http://localhost:5173}
      allowed-methods: GET,POST,PUT,PATCH,DELETE,OPTIONS
      # üõ°Ô∏è S√âCURIT√â : Headers sp√©cifiques uniquement (pas de wildcard)
      allowed-headers: Content-Type,Authorization,X-Requested-With,Accept,X-CSRF-Token
      allow-credentials: true    # Important pour les cookies cross-origin
      max-age: 3600

    # Rate Limiting (par IP)
    rate-limit:
      enabled: true
      requests-per-minute: 60
      auth-requests-per-minute: 10  # Plus strict pour /auth/*

    # Brute Force Protection
    brute-force:
      max-attempts: 5
      lock-duration: 15m
  name: ${APP_NAME:Template API}
  frontend-url: ${FRONTEND_URL:http://localhost:5173}
  mail:
    enabled: ${MAIL_ENABLED:false}       # Mettre e true en production
    from: ${MAIL_FROM:noreply@template.com}

# ???????????????????????????????????????????????????????????????????????????????
# ACTUATOR (Monitoring)
# ???????????????????????????????????????????????????????????????????????????????
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
  info:
    env:
      enabled: true

# ???????????????????????????????????????????????????????????????????????????????
# EMAIL
# ???????????????????????????????????????????????????????????????????????????????
spring.mail:
  host: ${MAIL_HOST:smtp.gmail.com}
  port: ${MAIL_PORT:587}
  username: ${MAIL_USERNAME:fe.benseddik@gmail.com}
  password: ${MAIL_PASSWORD:ibzzdojtdqndvrjs}
  properties:
    mail:
      smtp:
        auth: false
        starttls:
          enable: false
          required: false

# ???????????????????????????????????????????????????????????????????????????????
# LOGGING
# ???????????????????????????????????????????????????????????????????????????????
logging:
  level:
    root: INFO
    com.company.backend: DEBUG
    org.springframework.security: INFO
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"